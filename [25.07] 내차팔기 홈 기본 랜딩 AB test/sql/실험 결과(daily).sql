-- AB test 결과 분석 쿼리 (platform 에 따라 서로다른 컬럼에 들어오는 것을 통합하여 처리 하는 쿼리)
-- Mobile : ABTEST 컬럼
-- App : TESTTYPE 컬럼

-- MW 내차팔기 홈 디폴트 랜딩 AB test 
-- AB test 실험 참여된 시점 이후부터 모든 이벤트에 해당 컬럼으로 덮어 씌운 뒤 진행 -> 이유는 특정 페이지에서만 AB test 컬럼이 들어온다고 함. 그래서 정작 봐야하는 이벤트에 AB test 컬럼이 없기 때문에 이렇게 후처리로 진행.
-- 이 쿼리로 할 경우 원래 데이터(ver.1) 보다 -0.5% 정도 의 모수 차이가 남.

SET abtestId = 'ab_685cd44042161e1e5fb4245c';           -- 분석 대상 AB test ID
SET start_date = '2025-06-30';                          -- 분석 시작일
SET end_date = '2025-07-07';                            -- 분석 종료일
-- SET end_date = '2025-06-30';                            -- 분석 종료일

WITH 

log_base AS (

    SELECT
        BASE_DATE,
        EVENTTIME,
        PCID,
        ABTEST,
        TESTTYPE,
        SCREENNAME,
        EVENTTYPE,
        EVENTNAME,
        EVENTNAMEGROUP,
        BOARD,
        STATUS,
        OS_TYPE,
        OS_DETAIL,
        NULLIF(TRIM(f.value::STRING), '') AS ABTEST_SPLIT,
        SPLIT_PART(ABTEST_SPLIT, '_', 1) || '_' || SPLIT_PART(ABTEST_SPLIT, '_', 2) AS ABTEST_ID,
        SPLIT_PART(ABTEST_SPLIT, '_', 3) AS ABTEST_GROUP,
    FROM
        ENCAR.LOGS.ENLOG_ENCAR AS t1,
        LATERAL FLATTEN(input => SPLIT(t1.ABTEST, ',')) AS f
    WHERE
        1=1
        AND BASE_DATE BETWEEN $start_date AND $end_date
        AND OS_TYPE = 'mw'
        -- AND NOT (ess.OS_TYPE = 'app' AND ess.OS_DETAIL = 'ios')
),

mw_test_join_dt AS (        -- PCID 별 ABTEST 실험 최초참여시간 GROUP (Mobile web)

    SELECT
        PCID,
        EVENTTIME AS TEST_JOIN_DT,
        ABTEST_ID,
        ABTEST_GROUP,
    FROM
        log_base
    WHERE
        1=1
        AND ABTEST_ID = $abtestId
        AND OS_TYPE IN ('mw', 'pc')
    QUALIFY ROW_NUMBER() OVER (PARTITION BY PCID ORDER BY EVENTTIME) = 1        -- 최초 실험 참여시점의 행만 가져오는 로직
),

app_test_join_dt AS (         -- PCID 별 ABTEST 실험 최초참여시간 GROUP (App)

    SELECT
        PCID,
        EVENTTIME AS TEST_JOIN_DT,
        $abtestId AS ABTEST_ID,
        TESTTYPE AS ABTEST_GROUP,
    FROM
        log_base
    WHERE
        1=1
        AND OS_TYPE = 'app'
        AND TESTTYPE IS NOT NULL
        AND TESTTYPE != ''
    QUALIFY ROW_NUMBER() OVER (PARTITION BY PCID ORDER BY EVENTTIME) = 1                -- 최초 실험 참여시점의 행만 가져오는 로직
),

totl_test_join_dt AS (
    SELECT * FROM mw_test_join_dt
    UNION ALL
    SELECT * FROM app_test_join_dt
),

prep AS (
    SELECT
        t1.PCID,
        t1.BASE_DATE,
        t1.SCREENNAME,
        t1.EVENTTYPE,
        t1.EVENTNAME,
        t1.EVENTNAMEGROUP,
        t1.BOARD,
        t1.STATUS,
        t1.OS_TYPE,
        t1.OS_DETAIL,
        t2.ABTEST_ID,
        t2.ABTEST_GROUP,
    FROM
        log_base AS t1
        LEFT JOIN totl_test_join_dt AS t2 ON t1.PCID = t2.PCID AND t1.EVENTTIME >= t2.TEST_JOIN_DT
    WHERE
        1=1
        AND t2.ABTEST_ID IS NOT NULL
)

SELECT
    ABTEST_ID,
    MIN(BASE_DATE) AS START_DATE,
    MAX(BASE_DATE) AS END_DATE,
    OS_TYPE,
    ABTEST_GROUP,
    -- OS_DETAIL,
    BASE_DATE,
    
    COUNT(DISTINCT PCID) AS TOTAL_PCID,
    COUNT(PCID) AS TOTAL_EVENT,

    -- 내차팔기 영역
    COUNT(DISTINCT CASE WHEN EVENTTYPE = 'VIEW' AND SCREENNAME = '엔카홈' AND BOARD ='내차팔기' THEN PCID END) AS SELL_HOME,       -- 내차팔기 퍼널 1 - 번호판 조회
    COUNT(DISTINCT CASE WHEN EVENTTYPE = 'VIEW' AND SCREENNAME = '비교견적신청_소유자확인' THEN PCID END) AS CHECK_OWNER,              -- 내차팔기 퍼널 2- 소유자 확인
    COUNT(DISTINCT CASE WHEN EVENTTYPE = 'VIEW' AND SCREENNAME = '비교견적신청_정보확인중' THEN PCID END) AS TRY_MYGARAGE,              -- 내차팔기 퍼널 3- 내차고 등록 시도
    COUNT(DISTINCT CASE WHEN EVENTTYPE = 'VIEW' AND SCREENNAME = '엔카홈' AND BOARD = '내차고' AND STATUS = '정보입력중' THEN PCID END) AS MYCAR_HOME_ING,
    -- -- 비교견적 신청 완료 이벤트
    COUNT(DISTINCT CASE WHEN EVENTTYPE = 'VIEW' AND SCREENNAME IN ('비교견적신청_신청완료', '비교견적신청_프로신청완료', '비교견적플러스신청_신청완료') THEN PCID END) AS ESTIMATE_COMPLETE,


    -- 내차사기 영역
    COUNT(DISTINCT CASE WHEN EVENTTYPE = 'VIEW' AND SCREENNAME = '엔카홈' AND BOARD ='내차사기' THEN PCID END) AS BUY_HOME,
    COUNT(DISTINCT CASE WHEN EVENTTYPE = 'VIEW' AND SCREENNAME = '검색'                      THEN PCID END) AS SEARCH_HOME,
    COUNT(DISTINCT CASE WHEN EVENTTYPE = 'VIEW' AND SCREENNAME = '차량상세'                   THEN PCID END) AS CAR_DETAIL,
    COUNT(DISTINCT CASE WHEN EVENTTYPE = 'CLICK' AND SCREENNAME = '차량상세' AND EVENTNAME  IN ('문의하기', '엔카를통해구매하기') THEN PCID END) AS CAR_DETAIL_CONTACT,
    
FROM
    prep
WHERE
    1=1
    -- AND ABTEST_ID1 = $abtestId
GROUP BY
    ALL
ORDER BY
    ABTEST_GROUP, BASE_DATE
;

-- 결과값
/*
ABTEST_ID	START_DATE	END_DATE	OS_TYPE	ABTEST_GROUP	BASE_DATE	TOTAL_PCID	TOTAL_EVENT	SELL_HOME	CHECK_OWNER	TRY_MYGARAGE	MYCAR_HOME_ING	ESTIMATE_COMPLETE	BUY_HOME	SEARCH_HOME	CAR_DETAIL	CAR_DETAIL_CONTACT	내차팔기 홈(번호판 조회)	소유자명 확인 페이지	차량정보확인중 (내차고 등록 시도)	내차고 홈 (정보입력중)	비교견적 최종 신청 완료	내차사기 홈	검색 홈	차량 상세	차량 상세 - 문의하기 버튼 클릭
ab_685cd44042161e1e5fb4245c	2025-06-30	2025-06-30	mw	A	2025-06-30	55562	22220755	3988	1238	1059	875	74	43058	48780	40908	743	7.18%	2.23%	1.91%	1.57%	0.13%	77.50%	87.79%	73.63%	1.34%
ab_685cd44042161e1e5fb4245c	2025-07-01	2025-07-01	mw	A	2025-07-01	77342	33232597	4824	1328	1134	1037	83	55551	65995	56871	937	6.24%	1.72%	1.47%	1.34%	0.11%	71.83%	85.33%	73.53%	1.21%
ab_685cd44042161e1e5fb4245c	2025-07-02	2025-07-02	mw	A	2025-07-02	80401	34490521	4191	1030	896	851	96	55632	67727	59314	1056	5.21%	1.28%	1.11%	1.06%	0.12%	69.19%	84.24%	73.77%	1.31%
ab_685cd44042161e1e5fb4245c	2025-07-03	2025-07-03	mw	A	2025-07-03	80299	34115401	4191	1050	897	864	100	53632	66949	59258	1030	5.22%	1.31%	1.12%	1.08%	0.12%	66.79%	83.37%	73.80%	1.28%
ab_685cd44042161e1e5fb4245c	2025-07-04	2025-07-04	mw	A	2025-07-04	80031	34095533	4039	957	815	775	86	53256	66261	59336	1057	5.05%	1.20%	1.02%	0.97%	0.11%	66.54%	82.79%	74.14%	1.32%
ab_685cd44042161e1e5fb4245c	2025-07-05	2025-07-05	mw	A	2025-07-05	84859	38539065	4200	925	784	733	56	58136	71593	63722	1098	4.95%	1.09%	0.92%	0.86%	0.07%	68.51%	84.37%	75.09%	1.29%
ab_685cd44042161e1e5fb4245c	2025-07-06	2025-07-06	mw	A	2025-07-06	89437	42511629	4515	1035	907	857	52	62047	76138	68053	1083	5.05%	1.16%	1.01%	0.96%	0.06%	69.38%	85.13%	76.09%	1.21%
ab_685cd44042161e1e5fb4245c	2025-07-07	2025-07-07	mw	A	2025-07-07	86529	38117021	4487	1134	984	919	106	55641	71204	64207	1158	5.19%	1.31%	1.14%	1.06%	0.12%	64.30%	82.29%	74.20%	1.34%
ab_685cd44042161e1e5fb4245c	2025-06-30	2025-06-30	mw	B	2025-06-30	6203	2446657	5983	286	224	175	4	4644	5200	4391	66	96.45%	4.61%	3.61%	2.82%	0.06%	74.87%	83.83%	70.79%	1.06%
ab_685cd44042161e1e5fb4245c	2025-07-01	2025-07-01	mw	B	2025-07-01	8340	3636471	7579	290	222	190	9	5927	6846	6062	90	90.88%	3.48%	2.66%	2.28%	0.11%	71.07%	82.09%	72.69%	1.08%
ab_685cd44042161e1e5fb4245c	2025-07-02	2025-07-02	mw	B	2025-07-02	8873	3864448	7867	295	214	197	12	6207	7190	6366	114	88.66%	3.32%	2.41%	2.22%	0.14%	69.95%	81.03%	71.75%	1.28%
ab_685cd44042161e1e5fb4245c	2025-07-03	2025-07-03	mw	B	2025-07-03	8766	3694485	7597	270	214	199	10	6071	7123	6400	126	86.66%	3.08%	2.44%	2.27%	0.11%	69.26%	81.26%	73.01%	1.44%
ab_685cd44042161e1e5fb4245c	2025-07-04	2025-07-04	mw	B	2025-07-04	8891	3855186	7645	278	203	190	12	6041	7170	6481	117	85.99%	3.13%	2.28%	2.14%	0.13%	67.95%	80.64%	72.89%	1.32%
ab_685cd44042161e1e5fb4245c	2025-07-05	2025-07-05	mw	B	2025-07-05	9182	4205508	7945	302	225	206	4	6434	7547	6782	112	86.53%	3.29%	2.45%	2.24%	0.04%	70.07%	82.19%	73.86%	1.22%
ab_685cd44042161e1e5fb4245c	2025-07-06	2025-07-06	mw	B	2025-07-06	9841	4581909	8524	312	239	223	10	6850	8114	7385	108	86.62%	3.17%	2.43%	2.27%	0.10%	69.61%	82.45%	75.04%	1.10%
ab_685cd44042161e1e5fb4245c	2025-07-07	2025-07-07	mw	B	2025-07-07	9480	4133876	7875	292	238	227	13	6372	7618	6910	131	83.07%	3.08%	2.51%	2.39%	0.14%	67.22%	80.36%	72.89%	1.38%

*/